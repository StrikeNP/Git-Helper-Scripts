==============================================
USERS GUIDE FOR WRF STATISTICAL OUTPUT PACKAGE
==============================================

Takanobu Yamaguchi, CIRES CU & NOAA ESRL: tak.yamaguchi@noaa.gov

1. Inside of this package (/Path2WRF/test/em_les/stat)
This package should contain three files and one directory: lst, prm, README.stat, /stat2nc
The source code of this package is /Path2WRF/frame/module_statistics.F

2. Limitations
The current version only works with the EM core and flat surface, and without nesting.
The current version does not stop WRF if the above limitations are violated.
The current version assumes all map scale factor be 1, so do not use with any map projections.
Do not compile with OpenMP.

3. Preprocess and compile
To use this package, add -DWRFSTAT in ARCHFLAGS in configure.wrf.
Do not compile with OpenMP.

4. Edit prm
Set following options:

    ! Output file name, which has to end with .stat.
    ! Default file name is wrf.stat.
    ! The length of stat_file_name is 148.
    stat_file_name ='wrf.stat'

    ! Interval in steps to compute statistics.
    ! The frequency of saving restart data has to be divisible without remainder by nstat
    ! restart_interval in steps has to be divisible without remainder by nstat
    nstat = 100
 
    ! Frequency of computing statistics in steps = number of samples collected over nstat
    ! nstat has to be divisible without remainder by nstatfrq
    nstatfrq = 10
 
    ! Set true if LES.
    ! Default = .FALSE.
    LES = .TRUE.

    ! Option for performing time mean for precipitation rate over nstat by collecting flux every time step
    ! Defualt = .FALSE.
    doavgprecflux = .FALSE.

    ! Option for liquid cloud and ice cloud conditional statistics
    ! Default = .FALSE.
    docldconditionals = .FALSE.

    ! Option for liquid water condensate (QC+QR) and ice water condensate (QI+QS+QG) conditional statistics
    ! Default = .FALSE.
    docndconditionals = .FALSE.

    ! Option for core updraft, core downdraft conditional statistics
    ! Default = . FALSE.
    docoreconditionals = . FALSE.
 
    ! Option for cloudy updrafts, cloudy downdrafts and cloud-free conditional statistics
    ! Default = . FALSE.
    dosatupdnconditionals = . FALSE.

    ! Option for updrafts and downdrafts conditional statistics
    ! Default = . FALSE.
    doupdnconditionals = . FALSE.

    ! Number of layers between two output levels.
    ! This high resolution level is used for the mean profile calculation for flux and moment.
    ! If hrlayers = 1, the output level and high resolution level are same. 
    ! Default = 10
    hrlayers = 10

    ! Minimum threshold for moisture variables (cloud water, cloud ice, rain, snow, graupel).
    ! Each grid value will be reset to 0 if it is smaller than threshold.
    ! Set dousednc = .TRUE. if the threshold is droplet number concentration instead of mixing ratio.
    ! Unit for mixing ratio is g/kg, the unit for droplet number concentration is #/mg (~#/cm3)
    ! Default threshold is 0. Default dousednc = .FALSE.
    qc_threshold = 0.01
    qi_threshold = 0.
    qr_threshold = 0.001
    qs_threshold = 0.
    qg_threshold = 0.
    dousednc = .FALSE.

These parameters will be moved to namelist.input for future.

5. Edit namelist.input
Set e_we and e_sn to be odd number.
Set restart_interval so that restart_interval/dt (steps) has to be divisible without remainder by nstat

Advection
Set h_mom_adv_order=5, v_mom_adv_order=3, h_sca_adv_order=5, v_sca_adv_order=3, moist_adv_opt=2, scalar_adv_opt=2, tke_adv_opt=2
WRF runs with other options, but no resolved scale flux is output.

Diffusion
Set diff_opt=2.
With km_opt=2, the SGS TKE and its tendency are output
km_opt=3 (Smagorinsky) works but no SGS TKE output.
Without bl_pbl_physics=0, no SGS flux is output.

Microphysics
In order to output precipitation flux, condensation rate, evaporation rate, set Feingold scheme. Compile with -DESRL.

Radiation
In order to output radiative flux, use DYCOMS-II RF01 parameterization, CAM or RRTMG scheme.

6. Output and ./stat2nc
- The lst file lists output variables. Do not move from the stat directory (/Path2WRF/test/em_les/stat).
  Also, see the subroutine hbuf_conditionals_init for conditional average output.
- The output file of this package is created and saved in the stat directory.
  The output file is in a binary format and has an extension of ".stat"
- For the initial run, WRF stops if a stat file with the same name to be saved exists in order to avoid overwriting.
- The stat2nc directory contains a conversion program from .stat to netCDF, which is called stat2nc.
  Modify Makefile for your platform. Type "stat2nc ###.stat" to convert to ###.nc.

7. Restart
For restart run, ###.stat has to be located in the stat directory. The new data will be appended.

8. Notes
- User may want to see the subroutine wrf_statistics, statistics, hbuf_write.
- Although most of unit are correct for all microphysics schemes, the units are correct only for the Feingold scheme.
  The units for other schemes have not been all checked. User should check them, and please let me know for update.
  User may want to see the subroutine wrf_statistics.
- Depending on which microphysics, radiation schemes are used, some output variables (e.g., condensation rate, radiative flux, etc.) are not available
  simply because there is no such a variable in the scheme or the necessary code to collect data has not been implemented.
- I gladly accept user's request for new output variables. Do not hesitate to ask.


